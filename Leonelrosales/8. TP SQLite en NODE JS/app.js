const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./empresa.db', (err) => {
if (err) return console.error('‚ùå Error al conectar:', err.message);
console.log('‚úÖ Conectado a la base de datos empresa.db');
});

db.serialize(() => {
  // =======================
  // Ejercicio 1.1 - Tabla usuarios
  // =======================
db.run(`
    CREATE TABLE IF NOT EXISTS usuarios (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE
    )
`, (err) => {
    if (err) return console.error('‚ùå Error al crear tabla usuarios:', err.message);
    console.log('‚úÖ Tabla "usuarios" lista.');
});

  // =======================
  // Ejercicio 1.2 - Tabla productos
  // =======================
db.run(`
    CREATE TABLE IF NOT EXISTS productos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    precio REAL NOT NULL,
    stock INTEGER DEFAULT 0
    )
`, (err) => {
    if (err) return console.error('‚ùå Error al crear tabla productos:', err.message);
    console.log('‚úÖ Tabla "productos" lista.');
});

  // =======================
  // Ejercicio 2.1 - Insertar un usuario
  // =======================
db.run(`INSERT INTO usuarios (nombre, email) VALUES (?, ?)`, 
    ["Ana L√≥pez", "ana.lopez@example.com"],
    function(err) {
    if (err) console.error('‚ùå Insert Ana:', err.message);
    else console.log(`‚úÖ Ana L√≥pez insertada con ID: ${this.lastID}`);
    }
);

  // =======================
  // Ejercicio 2.2 - Insertar m√∫ltiples usuarios
  // =======================
const nuevosUsuarios = [
    { nombre: "Carlos Garc√≠a", email: "carlos.garcia@example.com" },
    { nombre: "Laura Mart√≠nez", email: "laura.martinez@example.com" },
    { nombre: "Pedro Rodr√≠guez", email: "pedro.rodriguez@example.com" }
];

nuevosUsuarios.forEach(u => {
    db.run(`INSERT INTO usuarios (nombre, email) VALUES (?, ?)`, 
    [u.nombre, u.email],
    function(err) {
        if (err) console.error(`‚ùå Error insertando ${u.nombre}:`, err.message);
        else console.log(`‚úÖ ${u.nombre} insertado con ID: ${this.lastID}`);
    }
    );
});

  // =======================
  // Ejercicio 2.3 - Insertar productos
  // =======================
const nuevosProductos = [
    { nombre: "Laptop Gamer", precio: 1250.75, stock: 15 },
    { nombre: "Teclado Mec√°nico", precio: 150.50, stock: 30 },
    { nombre: "Monitor 27 pulgadas", precio: 300.00, stock: 25 }
];

nuevosProductos.forEach(p => {
    db.run(`INSERT INTO productos (nombre, precio, stock) VALUES (?, ?, ?)`, 
    [p.nombre, p.precio, p.stock],
    function(err) {
        if (err) console.error(`‚ùå Error insertando producto ${p.nombre}:`, err.message);
        else console.log(`‚úÖ Producto ${p.nombre} insertado con ID: ${this.lastID}`);
    }
    );
});

  // =======================
  // Ejercicio 3.1 - Obtener todos los usuarios ordenados por nombre
  // =======================
  db.all(`SELECT * FROM usuarios ORDER BY nombre`, [], (err, rows) => {
    if (err) return console.error('‚ùå Error consultando usuarios:', err.message);
    console.log("\nüë• Usuarios ordenados:");
    rows.forEach(row => console.log(`- ${row.nombre} (${row.email})`));
});

  // =======================
  // Ejercicio 3.2 - Obtener un usuario por ID
  // =======================
  db.get(`SELECT * FROM usuarios WHERE id = ?`, [2], (err, row) => {
    if (err) return console.error('‚ùå Error buscando ID 2:', err.message);
    console.log("\nüîç Usuario con ID 2:", row ? row.nombre : "No encontrado");
});

  db.get(`SELECT * FROM usuarios WHERE id = ?`, [999], (err, row) => {
    if (err) return console.error('‚ùå Error buscando ID 999:', err.message);
    console.log("üîç Usuario con ID 999:", row ? row.nombre : "No encontrado");
});

  // =======================
  // Ejercicio 3.3 - Buscar usuarios por dominio @example.com
  // =======================
  db.all(`SELECT * FROM usuarios WHERE email LIKE ?`, ['%@example.com'], (err, rows) => {
    if (err) return console.error('‚ùå Error buscando emails:', err.message);
    console.log("\nüìß Usuarios con email @example.com:");
    rows.forEach(row => console.log(`- ${row.nombre} (${row.email})`));
});

  // =======================
  // Ejercicio 3.4 - Buscar productos por rango de precio (100 a 500)
  // =======================
  db.all(`SELECT * FROM productos WHERE precio BETWEEN ? AND ?`, [100, 500], (err, rows) => {
    if (err) return console.error('‚ùå Error buscando productos:', err.message);
    console.log("\nüí∞ Productos entre $100 y $500:");
    rows.forEach(row => console.log(`- ${row.nombre}: $${row.precio}`));
});

  // =======================
  // Ejercicio 3.5 - Procesar usuarios uno por uno
  // =======================
db.each(`SELECT nombre FROM usuarios`, [], (err, row) => {
    if (err) return console.error('‚ùå Error en db.each:', err.message);
    console.log(`üëã Hola, ${row.nombre}`);
}, (err, count) => {
    if (err) return console.error('‚ùå Error final de db.each:', err.message);
    console.log(`‚úÖ Se ha saludado a todos los usuarios. Total: ${count}`);
});

// =======================
// Ejercicio 4.1 - Actualizar el Email de un Usuario
// =======================
db.run(
`UPDATE usuarios SET email = ? WHERE id = ?`,
["nuevo.email@example.com", 2],
function(err) {
    if (err) return console.error("‚ùå Error actualizando email:", err.message);
    if (this.changes === 0) {
    console.log("‚ö†Ô∏è No se encontr√≥ el usuario con ID 2 para actualizar.");
    } else {
    console.log(`‚úÖ Email actualizado correctamente para el usuario con ID 2.`);
    }
}
);

// =======================
// Ejercicio 4.2 - Incrementar Stock de un Producto
// =======================
db.run(
`UPDATE productos SET stock = stock + ? WHERE id = ?`,
[10, 1],
function(err) {
    if (err) return console.error("‚ùå Error actualizando stock:", err.message);
    if (this.changes === 0) {
    console.log("‚ö†Ô∏è No se encontr√≥ el producto con ID 1 para actualizar stock.");
    } else {
    console.log("‚úÖ Stock incrementado en 10 unidades para el producto con ID 1.");
    }
}
);

// =======================
// Ejercicio 5.1 - Eliminar un Usuario por Email
// =======================
db.run(
`DELETE FROM usuarios WHERE email = ?`,
["pedro.rodriguez@example.com"],
function(err) {
    if (err) return console.error("‚ùå Error al eliminar usuario:", err.message);
    if (this.changes === 0) {
    console.log("‚ö†Ô∏è No se encontr√≥ usuario con ese email para eliminar.");
    } else {
    console.log(`‚úÖ Usuario con email "pedro.rodriguez@example.com" eliminado.`);
    }
}
);

// =======================
// Ejercicio 5.2 - Eliminar Productos sin Stock
// =======================
db.run(
`DELETE FROM productos WHERE stock = 0`,
[],
function(err) {
    if (err) return console.error("‚ùå Error al eliminar productos sin stock:", err.message);
    if (this.changes === 0) {
    console.log("‚ÑπÔ∏è No hab√≠a productos con stock = 0 para eliminar.");
    } else {
    console.log(`‚úÖ ${this.changes} producto(s) sin stock eliminado(s).`);
    }
}
);

// =======================
// Ejercicio 7.1 - Crear tabla posts con FOREIGN KEY
// =======================
db.run(`
CREATE TABLE IF NOT EXISTS posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    titulo TEXT NOT NULL,
    contenido TEXT NOT NULL,
    autor_id INTEGER,
    FOREIGN KEY (autor_id) REFERENCES usuarios(id)
)
`, (err) => {
if (err) return console.error("‚ùå Error al crear tabla posts:", err.message);
console.log("‚úÖ Tabla 'posts' lista.");
});

// Insertar algunos posts
const posts = [
{ titulo: "Bienvenidos al blog", contenido: "Este es el primer post", autor_id: 1 },
{ titulo: "Tips de programaci√≥n", contenido: "Usa async/await en Node.js", autor_id: 2 }
];

posts.forEach(post => {
db.run(
    `INSERT INTO posts (titulo, contenido, autor_id) VALUES (?, ?, ?)`,
    [post.titulo, post.contenido, post.autor_id],
    function(err) {
    if (err) return console.error(`‚ùå Error insertando post "${post.titulo}":`, err.message);
    console.log(`‚úÖ Post "${post.titulo}" insertado con ID: ${this.lastID}`);
    }
);
});

// Consulta con JOIN para mostrar nombre del autor
db.all(`
SELECT posts.titulo, posts.contenido, usuarios.nombre AS autor
FROM posts
JOIN usuarios ON posts.autor_id = usuarios.id
`, [], (err, rows) => {
if (err) return console.error("‚ùå Error en consulta JOIN:", err.message);
console.log("\nüìù Posts con nombre de autor:");
rows.forEach(row => {
    console.log(`- "${row.titulo}" por ${row.autor}: ${row.contenido}`);
});
});

// =======================
// Ejercicio 7.2 - Funci√≥n query con Promesas + async/await
// =======================
function query(sql, params = []) {
return new Promise((resolve, reject) => {
    db.all(sql, params, (err, rows) => {
    if (err) reject(err);
    else resolve(rows);
    });
});
}
async function mostrarUsuariosConPromesa() {
console.log("\nüìã Usuarios usando Promesas:");
try {
    const usuarios = await query(`SELECT * FROM usuarios ORDER BY nombre`);
    usuarios.forEach(u => {
    console.log(`- ${u.nombre} (${u.email})`);
    });
} catch (err) {
    console.error("‚ùå Error en mostrarUsuariosConPromesa:", err.message);
}
}
mostrarUsuariosConPromesa();

// =======================
// Ejercicio 7.3 - Buscar posts por email del autor (JOIN + WHERE)
// =======================
db.all(`
SELECT posts.titulo, posts.contenido, usuarios.email
FROM posts
JOIN usuarios ON posts.autor_id = usuarios.id
WHERE usuarios.email = ?
`, ["laura.martinez@example.com"], (err, rows) => {
if (err) return console.error("‚ùå Error buscando posts por email:", err.message);
console.log("\nüîé Posts escritos por laura.martinez@example.com:");
if (rows.length === 0) {
    console.log("‚ÑπÔ∏è No hay posts de este autor.");
} else {
    rows.forEach(row => {
    console.log(`- "${row.titulo}": ${row.contenido}`);
    });
}
});

// ======================================
// Secci√≥n 6: Cierre de la Conexi√≥n
// ======================================
  // =======================
  // Cierre de conexi√≥n
  // =======================
db.close((err) => {
    if (err) return console.error('‚ùå Error al cerrar DB:', err.message);
    console.log('\nüîí Conexi√≥n cerrada correctamente.');
});
});
